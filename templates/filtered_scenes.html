{% extends "base.html" %}

{% block title %}Filtered Scenes - Stash-Filter{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Filtered Scenes</h2>
            <p class="text-muted">Scenes that were excluded by your filtering rules</p>
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Total Filtered</h5>
                            <h3 class="text-primary">{{ filtered_scenes|length }}</h3>
                            <small class="text-muted">All time</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">This Week</h5>
                            <h3 class="text-info">{{ this_week_count }}</h3>
                            <small class="text-muted">Last 7 days</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">With Exceptions</h5>
                            <h3 class="text-success">{{ filtered_scenes|selectattr('is_exception')|list|length }}</h3>
                            <small class="text-muted">Allowed through</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Filter Reasons</h5>
                            <h3 class="text-warning">{{ filter_reasons|length }}</h3>
                            <small class="text-muted">Unique reasons</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Reasons Breakdown -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Filter Reasons Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for reason, count in filter_reasons.items() %}
                                <div class="col-md-4 mb-2">
                                    <span class="badge bg-secondary me-2">{{ count }}</span>
                                    <span class="text-muted">{{ reason }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Management Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h6>Bulk Actions</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-warning" onclick="clearOldFilteredScenes(7)">
                                    Clear 7+ Days Old
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="clearOldFilteredScenes(30)">
                                    Clear 30+ Days Old
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearOldFilteredScenes(0)">
                                    Clear All (Keep Exceptions)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtered Scenes List -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Filtered Scenes ({{ filtered_scenes|length }})</h5>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="filterByReason('')">All</button>
                                {% for reason in filter_reasons.keys() %}
                                <button type="button" class="btn btn-outline-secondary" onclick="filterByReason('{{ reason }}')">
                                    {{ reason|replace('_', ' ')|title }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="card-body">
                            {% if filtered_scenes %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Scene</th>
                                                <th>Studio</th>
                                                <th>Performers</th>
                                                <th>Filter Reason</th>
                                                <th>Filtered Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="filtered-scenes-table">
                                            {% for scene in filtered_scenes %}
                                            <tr data-filter-reason="{{ scene.filter_reason }}" 
                                                class="{% if scene.is_exception %}table-success{% endif %}">
                                                <td>
                                                    <strong>{{ scene.title }}</strong>
                                                    {% if scene.release_date %}
                                                        <br><small class="text-muted">{{ scene.release_date }}</small>
                                                    {% endif %}
                                                    {% if scene.duration %}
                                                        <br><small class="text-muted">{{ (scene.duration / 60) | round(1) }} min</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ scene.studio or 'Unknown' }}
                                                </td>
                                                <td>
                                                    {% if scene.get_performers() %}
                                                        {{ scene.get_performers()[:3] | join(', ') }}
                                                        {% if scene.get_performers()|length > 3 %}
                                                            <br><small class="text-muted">+{{ scene.get_performers()|length - 3 }} more</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Unknown</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-danger">{{ scene.filter_category }}</span>
                                                    {% if scene.filter_details %}
                                                        <br><small class="text-muted">{{ scene.filter_details }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ scene.filtered_date.strftime('%Y-%m-%d %H:%M') }}
                                                </td>
                                                <td>
                                                    {% if scene.is_exception %}
                                                        <span class="badge bg-success">Exception</span>
                                                        {% if scene.exception_reason %}
                                                            <br><small class="text-muted">{{ scene.exception_reason }}</small>
                                                        {% endif %}
                                                        {% if scene.exception_date %}
                                                            <br><small class="text-muted">{{ scene.exception_date.strftime('%Y-%m-%d') }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-secondary">Filtered</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if scene.is_exception %}
                                                        {% for exception in scene.exceptions %}
                                                            {% if exception.is_active and not exception.is_expired() %}
                                                                <button class="btn btn-sm btn-outline-danger" 
                                                                        onclick="removeException({{ exception.id }}, '{{ scene.title|e }}')">
                                                                    Remove Exception
                                                                </button>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <button class="btn btn-sm btn-success" 
                                                                onclick="createException({{ scene.id }}, '{{ scene.title|e }}')">
                                                            Create Exception
                                                        </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <h5 class="text-muted">No filtered scenes found</h5>
                                    <p class="text-muted">Scenes that match your unwanted categories will appear here.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exception Modal -->
<div class="modal fade" id="exceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Filter Exception</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="exception-scene-title"></strong>
                </div>
                
                <div class="mb-3">
                    <label for="exception-type" class="form-label">Exception Type</label>
                    <select class="form-select" id="exception-type">
                        <option value="permanent">Permanent - Always allow this scene</option>
                        <option value="temporary">Temporary - Allow for specified time</option>
                    </select>
                </div>
                
                <div class="mb-3" id="expires-section" style="display: none;">
                    <label for="expires-hours" class="form-label">Expires In (Hours)</label>
                    <input type="number" class="form-control" id="expires-hours" min="1" max="8760" value="168">
                    <small class="form-text text-muted">168 hours = 1 week</small>
                </div>
                
                <div class="mb-3">
                    <label for="exception-reason" class="form-label">Reason (Optional)</label>
                    <input type="text" class="form-control" id="exception-reason" 
                           placeholder="Why should this scene be allowed?">
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="auto-add-whisparr">
                    <label class="form-check-label" for="auto-add-whisparr">
                        Automatically add to wanted scenes
                    </label>
                    <small class="form-text text-muted d-block">
                        This will immediately add the scene to your wanted list
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitException()">Create Exception</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for the exception modal
let currentFilteredSceneId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Show/hide expires section based on exception type
    document.getElementById('exception-type').addEventListener('change', function() {
        const expiresSection = document.getElementById('expires-section');
        if (this.value === 'temporary') {
            expiresSection.style.display = 'block';
        } else {
            expiresSection.style.display = 'none';
        }
    });
});

function createException(filteredSceneId, sceneTitle) {
    currentFilteredSceneId = filteredSceneId;
    document.getElementById('exception-scene-title').textContent = sceneTitle;
    
    // Reset form
    document.getElementById('exception-type').value = 'permanent';
    document.getElementById('expires-hours').value = 168;
    document.getElementById('exception-reason').value = '';
    document.getElementById('auto-add-whisparr').checked = false;
    document.getElementById('expires-section').style.display = 'none';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('exceptionModal')).show();
}

function submitException() {
    const exceptionData = {
        filtered_scene_id: currentFilteredSceneId,
        exception_type: document.getElementById('exception-type').value,
        reason: document.getElementById('exception-reason').value || 'User exception',
        auto_add_to_whisparr: document.getElementById('auto-add-whisparr').checked
    };
    
    if (exceptionData.exception_type === 'temporary') {
        exceptionData.expires_hours = parseInt(document.getElementById('expires-hours').value);
    }
    
    fetch('/api/create-filter-exception', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(exceptionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('exceptionModal')).hide();
            
            let message = 'Exception created successfully!';
            if (data.auto_added) {
                message += ' Scene has been added to your wanted list.';
            }
            
            alert(message);
            location.reload(); // Refresh to show updated status
        } else {
            alert('Error creating exception: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error creating exception: ' + error.message);
    });
}

function removeException(exceptionId, sceneTitle) {
    if (confirm(`Remove exception for "${sceneTitle}"?\n\nThis will restore the original filter and hide this scene again.`)) {
        fetch('/api/remove-filter-exception', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({exception_id: exceptionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Exception removed successfully!');
                location.reload();
            } else {
                alert('Error removing exception: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error removing exception: ' + error.message);
        });
    }
}

function filterByReason(reason) {
    const rows = document.querySelectorAll('#filtered-scenes-table tr');
    
    rows.forEach(row => {
        if (reason === '' || row.dataset.filterReason === reason) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function clearOldFilteredScenes(days) {
    let message;
    if (days === 0) {
        message = 'Clear ALL filtered scenes (except those with exceptions)?';
    } else {
        message = `Clear filtered scenes older than ${days} days?`;
    }
    
    if (confirm(message)) {
        fetch('/api/clear-old-filtered-scenes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days: days})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`Successfully cleared ${data.deleted_count} old filtered scenes.`);
                location.reload();
            } else {
                alert('Error clearing scenes: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error clearing scenes: ' + error.message);
        });
    }
}
</script>
{% endblock %}